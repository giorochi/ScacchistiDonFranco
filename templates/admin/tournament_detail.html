{% extends "layout.html" %}

{% block title %}{{ tournament.name }} - Tournament Management{% endblock %}

{% block content %}
<div class="container">
    {% if editing %}
        <!-- Tournament Edit Form -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-edit"></i> Edit Tournament</h2>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{{ url_for('admin_tournament_edit', tournament_id=tournament.id) }}">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="name" class="form-label">Tournament Name *</label>
                                        <input type="text" class="form-control" id="name" name="name" value="{{ tournament.name }}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="description" class="form-label">Description</label>
                                        <textarea class="form-control" id="description" name="description" rows="3">{{ tournament.description or '' }}</textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="location" class="form-label">Location</label>
                                        <input type="text" class="form-control" id="location" name="location" value="{{ tournament.location or '' }}">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="start_date" class="form-label">Start Date *</label>
                                        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ tournament.start_date.strftime('%Y-%m-%d') }}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="end_date" class="form-label">End Date *</label>
                                        <input type="date" class="form-control" id="end_date" name="end_date" value="{{ tournament.end_date.strftime('%Y-%m-%d') }}" required>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="group_count" class="form-label">Group Count</label>
                                                <input type="number" class="form-control" id="group_count" name="group_count" min="1" value="{{ tournament.group_count }}">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="players_per_group" class="form-label">Players/Group</label>
                                                <input type="number" class="form-control" id="players_per_group" name="players_per_group" min="2" value="{{ tournament.players_per_group }}">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="knockout_players" class="form-label">KO Stage Players</label>
                                                <input type="number" class="form-control" id="knockout_players" name="knockout_players" min="2" value="{{ tournament.knockout_players }}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end mt-3">
                                <a href="{{ url_for('admin_tournament_detail', tournament_id=tournament.id) }}" class="btn btn-secondary me-2">Cancel</a>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Tournament Details View -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h2><i class="fas fa-trophy"></i> {{ tournament.name }}</h2>
                        <div>
                            <a href="{{ url_for('admin_tournament_edit', tournament_id=tournament.id) }}" class="btn btn-secondary me-2">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteTournamentModal">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <p class="lead">{{ tournament.description or 'No description available.' }}</p>
                                
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <h5><i class="fas fa-info-circle"></i> Tournament Details</h5>
                                        <table class="table table-sm">
                                            <tbody>
                                                <tr>
                                                    <th>Location:</th>
                                                    <td>{{ tournament.location or 'N/A' }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Start Date:</th>
                                                    <td>{{ tournament.start_date.strftime('%d/%m/%Y') }}</td>
                                                </tr>
                                                <tr>
                                                    <th>End Date:</th>
                                                    <td>{{ tournament.end_date.strftime('%d/%m/%Y') }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Status:</th>
                                                    <td>
                                                        <span class="tournament-status status-{{ tournament.status }}">
                                                            {{ tournament.status|replace('_', ' ')|title }}
                                                        </span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h5><i class="fas fa-cog"></i> Tournament Configuration</h5>
                                        <table class="table table-sm">
                                            <tbody>
                                                <tr>
                                                    <th>Group Count:</th>
                                                    <td>{{ tournament.group_count }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Players per Group:</th>
                                                    <td>{{ tournament.players_per_group }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Knockout Players:</th>
                                                    <td>{{ tournament.knockout_players }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Total Registered:</th>
                                                    <td>{{ tournament_players|length }} players</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header card-header-secondary">
                                        <h5>Tournament Actions</h5>
                                    </div>
                                    <div class="card-body">
                                        {% if tournament.status == 'draft' %}
                                            <!-- Actions for Draft phase -->
                                            <form method="post" action="{{ url_for('admin_tournament_create_groups', tournament_id=tournament.id) }}" class="mb-2">
                                                <button type="submit" class="btn btn-primary btn-sm d-block w-100" {% if tournament_players|length < 2 %}disabled{% endif %}>
                                                    <i class="fas fa-users"></i> Create Groups
                                                </button>
                                            </form>
                                            
                                        {% elif tournament.status == 'group_stage' %}
                                            <!-- Actions for Group Stage -->
                                            <form method="post" action="{{ url_for('admin_tournament_generate_matches', tournament_id=tournament.id) }}" class="mb-2">
                                                <button type="submit" class="btn btn-primary btn-sm d-block w-100">
                                                    <i class="fas fa-random"></i> Generate Group Matches
                                                </button>
                                            </form>
                                            
                                            <form method="post" action="{{ url_for('admin_tournament_update_standings', tournament_id=tournament.id) }}" class="mb-2">
                                                <button type="submit" class="btn btn-secondary btn-sm d-block w-100">
                                                    <i class="fas fa-sync"></i> Update Standings
                                                </button>
                                            </form>
                                            
                                            <form method="post" action="{{ url_for('admin_tournament_select_knockout', tournament_id=tournament.id) }}" class="mb-2">
                                                <div class="mb-3">
                                                    <label class="form-label">Select Players for Knockout Stage ({{ tournament.knockout_players }} required)</label>
                                                    <select name="player_ids" multiple class="form-select" size="8" required>
                                                        {% for tp in tournament_players %}
                                                            <option value="{{ tp.player_id }}">
                                                                {{ tp.player.name }} (Points: {{ tp.points }})
                                                            </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <button type="submit" class="btn btn-accent btn-sm d-block w-100">
                                                    <i class="fas fa-medal"></i> Select Knockout Players
                                                </button>
                                            </form>
                                            
                                        {% elif tournament.status == 'knockout_stage' %}
                                            <!-- Actions for Knockout Stage -->
                                            <form method="post" action="{{ url_for('admin_tournament_generate_knockout', tournament_id=tournament.id) }}" class="mb-2">
                                                <button type="submit" class="btn btn-primary btn-sm d-block w-100">
                                                    <i class="fas fa-sitemap"></i> Generate Knockout Matches
                                                </button>
                                            </form>
                                            
                                            <form method="post" action="{{ url_for('admin_tournament_complete', tournament_id=tournament.id) }}" class="mb-2">
                                                <button type="submit" class="btn btn-success btn-sm d-block w-100">
                                                    <i class="fas fa-flag-checkered"></i> Mark Tournament Complete
                                                </button>
                                            </form>
                                            
                                        {% elif tournament.status == 'completed' %}
                                            <!-- Actions for Completed Tournaments -->
                                            <div class="alert alert-success mb-2">
                                                <i class="fas fa-check-circle"></i> Tournament has been completed!
                                            </div>
                                        {% endif %}
                                        
                                        <a href="{{ url_for('tournament_view', tournament_id=tournament.id) }}" class="btn btn-outline-primary btn-sm d-block">
                                            <i class="fas fa-eye"></i> View Public Page
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tournament Content (Players, Groups, Matches) -->
        <div class="row">
            <div class="col-md-12">
                <ul class="nav nav-tabs mb-4" id="tournamentTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="players-tab" data-bs-toggle="tab" data-bs-target="#players" type="button" role="tab" aria-controls="players" aria-selected="true">
                            <i class="fas fa-users"></i> Players
                        </button>
                    </li>
                    {% if groups %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups" type="button" role="tab" aria-controls="groups" aria-selected="false">
                                <i class="fas fa-layer-group"></i> Groups
                            </button>
                        </li>
                    {% endif %}
                    {% if group_matches %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="group-matches-tab" data-bs-toggle="tab" data-bs-target="#group-matches" type="button" role="tab" aria-controls="group-matches" aria-selected="false">
                                <i class="fas fa-handshake"></i> Group Matches
                            </button>
                        </li>
                    {% endif %}
                    {% if knockout_matches %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="knockout-tab" data-bs-toggle="tab" data-bs-target="#knockout" type="button" role="tab" aria-controls="knockout" aria-selected="false">
                                <i class="fas fa-sitemap"></i> Knockout Stage
                            </button>
                        </li>
                    {% endif %}
                </ul>
                
                <div class="tab-content" id="tournamentTabContent">
                    <!-- Players Tab -->
                    <div class="tab-pane fade show active" id="players" role="tabpanel" aria-labelledby="players-tab">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h3>Registered Players</h3>
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPlayerModal">
                                    <i class="fas fa-plus"></i> Add Player
                                </button>
                            </div>
                            <div class="card-body">
                                {% if tournament_players %}
                                    <div class="table-container">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Access Code</th>
                                                    <th>Rating</th>
                                                    <th>Group</th>
                                                    <th>Points</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for tp in tournament_players %}
                                                    <tr>
                                                        <td>{{ tp.player.name }}</td>
                                                        <td>
                                                            <span class="badge bg-secondary">{{ tp.player.access_code }}</span>
                                                            <button class="btn btn-sm btn-link copy-access-code p-0 ms-1" data-access-code="{{ tp.player.access_code }}">
                                                                <i class="fas fa-copy"></i>
                                                            </button>
                                                        </td>
                                                        <td>{{ tp.player.rating or 'N/A' }}</td>
                                                        <td>{{ tp.group.name if tp.group else 'Not assigned' }}</td>
                                                        <td>{{ tp.points }}</td>
                                                        <td>
                                                            <form method="post" action="{{ url_for('admin_tournament_remove_player', tournament_id=tournament.id, player_id=tp.player_id) }}" class="d-inline">
                                                                <button type="submit" class="btn btn-sm btn-danger btn-delete" title="Remove from tournament">
                                                                    <i class="fas fa-user-minus"></i>
                                                                </button>
                                                            </form>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> No players registered for this tournament yet.
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Groups Tab -->
                    {% if groups %}
                        <div class="tab-pane fade" id="groups" role="tabpanel" aria-labelledby="groups-tab">
                            <div class="row">
                                {% for group in groups %}
                                    <div class="col-md-6 mb-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h4>{{ group.name }}</h4>
                                            </div>
                                            <div class="card-body">
                                                {% if group_standings and group_standings[group.id] %}
                                                    <div class="table-container">
                                                        <table class="table table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th>#</th>
                                                                    <th>Player</th>
                                                                    <th>Points</th>
                                                                    <th>Tiebreak</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for tp in group_standings[group.id] %}
                                                                    <tr>
                                                                        <td>{{ loop.index }}</td>
                                                                        <td>{{ tp.player.name }}</td>
                                                                        <td>{{ tp.points }}</td>
                                                                        <td>{{ tp.tiebreak_score }}</td>
                                                                    </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                {% else %}
                                                    <div class="alert alert-info">
                                                        <i class="fas fa-info-circle"></i> No standings available for this group.
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Group Matches Tab -->
                    {% if group_matches %}
                        <div class="tab-pane fade" id="group-matches" role="tabpanel" aria-labelledby="group-matches-tab">
                            <div class="card">
                                <div class="card-header">
                                    <h3>Group Stage Matches</h3>
                                </div>
                                <div class="card-body">
                                    <div class="table-container">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Group</th>
                                                    <th>Round</th>
                                                    <th>White</th>
                                                    <th>Black</th>
                                                    <th>Board</th>
                                                    <th>Time</th>
                                                    <th>Result</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for match in group_matches %}
                                                    <tr>
                                                        <td>{{ match.group.name if match.group else 'N/A' }}</td>
                                                        <td>{{ match.round }}</td>
                                                        <td>{{ match.white_player.name if match.white_player else 'TBD' }}</td>
                                                        <td>{{ match.black_player.name if match.black_player else 'TBD' }}</td>
                                                        <td>
                                                            {% if match.board_number %}
                                                                <span class="badge bg-primary">Board {{ match.board_number }}</span>
                                                            {% else %}
                                                                TBD
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if match.start_time %}
                                                                {{ match.start_time.strftime('%d/%m/%Y %H:%M') }}
                                                            {% else %}
                                                                TBD
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            <span class="badge
                                                                {% if match.result == 'white_win' %}bg-primary
                                                                {% elif match.result == 'black_win' %}bg-dark
                                                                {% elif match.result == 'draw' %}bg-warning
                                                                {% elif match.result == 'forfeit_white' %}bg-danger
                                                                {% elif match.result == 'forfeit_black' %}bg-danger
                                                                {% else %}bg-secondary{% endif %}">
                                                                {% if match.result == 'white_win' %}White wins
                                                                {% elif match.result == 'black_win' %}Black wins
                                                                {% elif match.result == 'draw' %}Draw
                                                                {% elif match.result == 'forfeit_white' %}White forfeited
                                                                {% elif match.result == 'forfeit_black' %}Black forfeited
                                                                {% elif match.status == 'scheduled' %}Scheduled
                                                                {% elif match.status == 'in_progress' %}In Progress
                                                                {% else %}No result{% endif %}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <a href="{{ url_for('admin_match_edit', match_id=match.id) }}" class="btn btn-sm btn-primary">
                                                                <i class="fas fa-edit"></i> Edit
                                                            </a>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Knockout Tab -->
                    {% if knockout_matches %}
                        <div class="tab-pane fade" id="knockout" role="tabpanel" aria-labelledby="knockout-tab">
                            <div class="card">
                                <div class="card-header">
                                    <h3>Knockout Stage</h3>
                                </div>
                                <div class="card-body">
                                    <!-- Knockout Bracket Visualization -->
                                    <div id="tournamentBracket" 
                                         class="mb-4" 
                                         data-matches='{{ knockout_matches|map(attribute="to_dict")|list|tojson }}' 
                                         data-rounds='{{ knockout_matches|map(attribute='round')|list|max }}'>
                                    </div>
                                    
                                    <!-- Knockout Matches List -->
                                    <h4 class="mt-4">Knockout Matches</h4>
                                    <div class="table-container">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Round</th>
                                                    <th>White</th>
                                                    <th>Black</th>
                                                    <th>Board</th>
                                                    <th>Time</th>
                                                    <th>Result</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for match in knockout_matches %}
                                                    <tr>
                                                        <td>{{ match.knockout_round|title if match.knockout_round else 'Round ' ~ match.round }}</td>
                                                        <td>{{ match.white_player.name if match.white_player else 'TBD' }}</td>
                                                        <td>{{ match.black_player.name if match.black_player else 'TBD' }}</td>
                                                        <td>
                                                            {% if match.board_number %}
                                                                <span class="badge bg-primary">Board {{ match.board_number }}</span>
                                                            {% else %}
                                                                TBD
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if match.start_time %}
                                                                {{ match.start_time.strftime('%d/%m/%Y %H:%M') }}
                                                            {% else %}
                                                                TBD
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            <span class="badge
                                                                {% if match.result == 'white_win' %}bg-primary
                                                                {% elif match.result == 'black_win' %}bg-dark
                                                                {% elif match.result == 'draw' %}bg-warning
                                                                {% elif match.result == 'forfeit_white' %}bg-danger
                                                                {% elif match.result == 'forfeit_black' %}bg-danger
                                                                {% else %}bg-secondary{% endif %}">
                                                                {% if match.result == 'white_win' %}White wins
                                                                {% elif match.result == 'black_win' %}Black wins
                                                                {% elif match.result == 'draw' %}Draw
                                                                {% elif match.result == 'forfeit_white' %}White forfeited
                                                                {% elif match.result == 'forfeit_black' %}Black forfeited
                                                                {% elif match.status == 'scheduled' %}Scheduled
                                                                {% elif match.status == 'in_progress' %}In Progress
                                                                {% else %}No result{% endif %}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <a href="{{ url_for('admin_match_edit', match_id=match.id) }}" class="btn btn-sm btn-primary">
                                                                <i class="fas fa-edit"></i> Edit
                                                            </a>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Add Player Modal -->
<div class="modal fade" id="addPlayerModal" tabindex="-1" aria-labelledby="addPlayerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPlayerModalLabel">Add Player to Tournament</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{{ url_for('admin_tournament_add_player', tournament_id=tournament.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="player_id" class="form-label">Select Player</label>
                        <select class="form-select" id="player_id" name="player_id" required>
                            <option value="">-- Select Player --</option>
                            {% for player in get_all_players() %}
                                {% if player.id not in tournament_players|map(attribute='player_id')|list %}
                                    <option value="{{ player.id }}">{{ player.name }} ({{ player.access_code }})</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Player</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Tournament Modal -->
<div class="modal fade" id="deleteTournamentModal" tabindex="-1" aria-labelledby="deleteTournamentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteTournamentModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the tournament <strong>{{ tournament.name }}</strong>?</p>
                <p class="text-danger">This action cannot be undone. All associated data including matches, groups, and player registrations will be permanently deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{{ url_for('admin_tournament_delete', tournament_id=tournament.id) }}">
                    <button type="submit" class="btn btn-danger">Delete Tournament</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // Helper function to get all players (used by the add player modal)
    function get_all_players() {
        // This is a template function that will be replaced with actual data when rendered
        return [];
    }
</script>
{% endblock %}
{% endblock %}
