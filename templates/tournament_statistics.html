{% extends "layout.html" %}

{% block title %}Analisi Statistiche Avanzate{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h1><i class="fas fa-chart-line"></i> Analisi Statistiche Avanzate</h1>
                </div>
                <div class="card-body">
                    <p class="lead">Visualizza grafici dettagliati, statistiche di torneo e tendenze delle performance dei giocatori.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Selezione Torneo -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h2>Seleziona il Torneo</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <form id="tournamentSelectForm">
                                <div class="mb-3">
                                    <label for="tournamentSelect" class="form-label">Torneo</label>
                                    <select class="form-select" id="tournamentSelect" name="tournament_id">
                                        <option value="" selected>Seleziona un torneo...</option>
                                        {% for tournament in tournaments %}
                                            <option value="{{ tournament.id }}">{{ tournament.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Visualizza Statistiche</button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <div class="tournament-info-container p-3 bg-light rounded">
                                <h4 id="selectedTournamentName">Nessun torneo selezionato</h4>
                                <p id="selectedTournamentDates"></p>
                                <p id="selectedTournamentStatus"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="statisticsContainer">
        <!-- Prima riga di grafici -->
        <div class="row mb-4">
            <!-- Grafico di Performance dei Giocatori -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3>Performance Giocatori</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="playerPerformanceChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <!-- Grafico a torta di Risultati Partite -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3>Distribuzione Risultati</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="matchResultsChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seconda riga di grafici -->
        <div class="row mb-4">
            <!-- Grafico di Progressione Giocatori -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3>Progressione Punteggi</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="playerProgressionChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <!-- Grafico Rendimento Gruppi -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h3>Rendimento Gruppi</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="groupPerformanceChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiche Generali -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3>Statistiche Generali</h3>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="stat-card p-3 mb-3 bg-light rounded">
                                    <h1 id="totalMatches">0</h1>
                                    <p>Partite Totali</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card p-3 mb-3 bg-light rounded">
                                    <h1 id="completedMatches">0</h1>
                                    <p>Partite Completate</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card p-3 mb-3 bg-light rounded">
                                    <h1 id="avgMatchTime">0</h1>
                                    <p>Durata Media Partite</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card p-3 mb-3 bg-light rounded">
                                    <h1 id="knockoutPlayers">0</h1>
                                    <p>Giocatori in Fase Knockout</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Nasconde il contenitore delle statistiche all'inizio
        document.getElementById('statisticsContainer').style.display = 'none';
        
        // Gestisce la selezione del torneo
        document.getElementById('tournamentSelectForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const tournamentId = document.getElementById('tournamentSelect').value;
            if (!tournamentId) return;
            
            // Mostra il contenitore delle statistiche
            document.getElementById('statisticsContainer').style.display = 'block';
            
            // Carica i dati del torneo selezionato
            loadTournamentData(tournamentId);
        });
        
        function loadTournamentData(tournamentId) {
            // In un'implementazione reale, faresti una chiamata API per ottenere questi dati
            // Per scopi dimostrativi, uso dati simulati
            
            // Aggiorna informazioni del torneo
            const selectedTournament = {
                name: document.querySelector(`#tournamentSelect option[value="${tournamentId}"]`).textContent,
                dates: "01/06/2023 - 15/06/2023",
                status: "Completato"
            };
            
            document.getElementById('selectedTournamentName').textContent = selectedTournament.name;
            document.getElementById('selectedTournamentDates').textContent = `Date: ${selectedTournament.dates}`;
            document.getElementById('selectedTournamentStatus').textContent = `Stato: ${selectedTournament.status}`;
            
            // Aggiorna statistiche generali
            document.getElementById('totalMatches').textContent = '48';
            document.getElementById('completedMatches').textContent = '42';
            document.getElementById('avgMatchTime').textContent = '45m';
            document.getElementById('knockoutPlayers').textContent = '8';
            
            // Carica i grafici
            loadPlayerPerformanceChart();
            loadMatchResultsChart();
            loadPlayerProgressionChart();
            loadGroupPerformanceChart();
        }
        
        function loadPlayerPerformanceChart() {
            const ctx = document.getElementById('playerPerformanceChart').getContext('2d');
            
            // Dati di esempio
            const data = {
                labels: ['Giocatore 1', 'Giocatore 2', 'Giocatore 3', 'Giocatore 4', 'Giocatore 5', 'Giocatore 6'],
                datasets: [{
                    label: 'Punti',
                    data: [4.5, 3.5, 5.0, 2.0, 4.0, 3.0],
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            };
            
            new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Punti per Giocatore'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 6
                        }
                    }
                }
            });
        }
        
        function loadMatchResultsChart() {
            const ctx = document.getElementById('matchResultsChart').getContext('2d');
            
            // Dati di esempio
            const data = {
                labels: ['Vittorie Bianco', 'Vittorie Nero', 'Pareggi', 'Forfeit'],
                datasets: [{
                    data: [18, 14, 8, 2],
                    backgroundColor: [
                        'rgba(255, 255, 255, 0.8)',
                        'rgba(54, 54, 54, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 99, 132, 0.8)'
                    ],
                    borderColor: [
                        'rgba(255, 255, 255, 1)',
                        'rgba(54, 54, 54, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 1
                }]
            };
            
            new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Distribuzione Risultati Partite'
                        }
                    }
                }
            });
        }
        
        function loadPlayerProgressionChart() {
            const ctx = document.getElementById('playerProgressionChart').getContext('2d');
            
            // Dati di esempio
            const data = {
                labels: ['Round 1', 'Round 2', 'Round 3', 'Round 4', 'Round 5'],
                datasets: [
                    {
                        label: 'Giocatore 1',
                        data: [1, 2, 3, 3.5, 4.5],
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: 'Giocatore 2',
                        data: [0, 1, 2, 3, 3.5],
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: 'Giocatore 3',
                        data: [1, 2, 3, 4, 5],
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: false
                    }
                ]
            };
            
            new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Progressione Punteggi nel Torneo'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function loadGroupPerformanceChart() {
            const ctx = document.getElementById('groupPerformanceChart').getContext('2d');
            
            // Dati di esempio
            const data = {
                labels: ['Gruppo A', 'Gruppo B', 'Gruppo C', 'Gruppo D'],
                datasets: [
                    {
                        label: 'Punti Medi',
                        data: [2.75, 2.25, 2.5, 2.6],
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Punteggio Massimo',
                        data: [5, 4, 4.5, 5],
                        backgroundColor: 'rgba(153, 102, 255, 0.5)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }
                ]
            };
            
            new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Prestazioni per Gruppo'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}